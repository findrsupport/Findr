<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Findrâ„¢ â€” Map</title>
  <meta name="description" content="Findrâ„¢ map view â€” mock listings with deterministic filters." />
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <!-- JUNIPER START: CLUSTER CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <!-- JUNIPER END: CLUSTER CSS -->
  <style>
    :root { --brand:#5ea1ff; --bg:#0b0f17; --fg:#e8eef7; --muted:#9fb0c9; --card:rgba(255,255,255,0.04); --stroke:#223148; --surface:#0f1624; --chip:#1a2335; --chip-border:#2a3c5a; }
    :root[data-theme="light"]{ --bg:#f7f9fc; --fg:#0e1420; --muted:#5a6c85; --card:#ffffff; --stroke:#e5ecf5; --surface:#ffffff; --chip:#f1f4f8; --chip-border:#e5ecf5; }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg)}
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 20px}

    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{font-weight:900}
    .navlinks{display:flex; align-items:center; gap:14px}
    .navlinks a{padding:8px 10px; border-radius:10px}
    .navlinks a.active{background:var(--card); border:1px solid var(--stroke)}
    .toggle{cursor:pointer; border:1px solid var(--stroke); background:var(--card); color:var(--fg); border-radius:10px; padding:8px 10px}

    .panel{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:14px; margin-bottom:14px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .muted{color:var(--muted)}
    details#why summary{cursor:pointer; color:var(--muted)}

    #map{height:72vh; width:100%; border-radius:16px; border:1px solid var(--stroke); overflow:hidden}
    .leaflet-popup-content { margin: 10px 14px; }
    .price{font-weight:900}
    .addr{font-weight:800}
    .meta{color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Nav -->
    <nav class="nav" role="navigation" aria-label="Primary">
      <div class="brand"><div class="logo" aria-label="Findr home">Findrâ„¢</div></div>
      <div class="navlinks">
        <a href="/">Home</a>
        <a href="listings.html">Listings</a>
        <a href="map.html" class="active" aria-current="page">Map</a>
        <button id="theme-toggle" class="toggle" type="button" aria-label="Toggle theme">ðŸŒ™</button>
      </div>
    </nav>

    <!-- Summary -->
    <div class="panel">
      <div class="row">
        <div class="muted" id="count" aria-live="polite">Loadingâ€¦</div>
        <div class="muted"><a id="list-link" href="listings.html" aria-label="View as a list">Switch to list â†’</a></div>
      </div>
      <details id="why">
        <summary>Why these results?</summary>
        <div id="why-body" class="muted" style="margin-top:6px;"></div>
      </details>
    </div>

    <!-- Map -->
    <div id="map" role="region" aria-label="Map of listings"></div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- JUNIPER START: CLUSTER JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- JUNIPER END: CLUSTER JS -->
  <script src="config.js"></script>
  <script src="js/ai-guard.js"></script>
  <script src="js/filters.js"></script>
  <script>
    // Theme toggle
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('theme');
      if (saved) root.setAttribute('data-theme', saved);
      const btn = document.getElementById('theme-toggle');
      const isDark = () => root.getAttribute('data-theme') !== 'light';
      const render = () => { if(btn) btn.textContent = isDark() ? 'ðŸŒ™' : 'â˜€ï¸'; };
      if (btn) {
        btn.addEventListener('click', () => {
          root.setAttribute('data-theme', isDark() ? 'light' : 'dark');
          localStorage.setItem('theme', root.getAttribute('data-theme'));
          render();
        });
      }
      render();
    })();

    // Helpers
    const $ = (id) => document.getElementById(id);
    const fmtPrice = (n) => new Intl.NumberFormat('en-CA', { style:'currency', currency:'CAD', maximumFractionDigits:0 }).format(n);

    function getParams(){
      const p = new URLSearchParams(location.search);
      return {
        q: p.get('q') || '',
        city: p.get('city') || '',
        beds: p.get('beds') || '',
        baths: p.get('baths') || '',
        minp: p.get('minp') || '',
        maxp: p.get('maxp') || ''
      };
    }

    function renderWhy(params){
      const parts=[];
      if (params.q) parts.push(`Text: â€œ${params.q}â€`);
      if (params.city) parts.push(params.city);
      if (params.beds) parts.push(`${params.beds}+ bed`);
      if (params.baths) parts.push(`${params.baths}+ bath`);
      const left = params.minp ? fmtPrice(+params.minp) : 'Any';
      const right = params.maxp ? fmtPrice(+params.maxp) : 'Any';
      if (params.minp || params.maxp) parts.push(`Price: ${left}â€“${right}`);
      $('why-body').textContent = parts.length ? parts.join(' Â· ') : 'No active filters (all listings).';
    }

    // Load data from multiple candidate paths (same as listings page)
    async function loadData(){
      const candidates = ['/data/listings.json','data/listings.json','/listings.json','listings.json'];
      for (const url of candidates){
        try{ const res = await fetch(url,{cache:'no-store'}); if(res.ok) return await res.json(); }catch(_e){}
      }
      throw new Error('Could not load listings.json from expected paths.');
    }

    // Map + markers (use clustering; normalize lonâ†’lng)
    var map, layer; // JUNIPER: var so they're globals (needed by some add-ons)
    function initMap(){
      map = L.map('map', { scrollWheelZoom: true });
      const dark = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      L.tileLayer(dark, { attribution: '&copy; OpenStreetMap' }).addTo(map);
      map.setView([49.2827, -123.1207], 11);

      // JUNIPER: create cluster group up-front (fast for 500â€“1,000 markers)
      layer = L.markerClusterGroup({
        maxClusterRadius: 60,
        spiderfyOnMaxZoom: true,
        chunkedLoading: true
      }).addTo(map);
    }

    function updateMarkers(list){
      layer.clearLayers();
      if (!list || !list.length) return;

      const bounds = [];
      list.forEach(it=>{
        // normalize lon->lng so markers render regardless of key used in JSON
        const lat = (typeof it.lat === 'number') ? it.lat : null;
        const lng = (typeof it.lng === 'number') ? it.lng : (typeof it.lon === 'number' ? it.lon : null);
        if (typeof lat !== 'number' || typeof lng !== 'number') return;

        const html = `
          <div class="addr">${it.address}</div>
          <div class="price">${fmtPrice(it.price)}</div>
          <div class="meta">${it.city} Â· ${it.beds} bd Â· ${it.baths} ba</div>
          <div style="margin-top:8px;">
            <a href="${it.realtorca_url}" target="_blank" rel="noopener">View on REALTOR.ca â†’</a>
          </div>`;
        const m = L.marker([lat, lng]).bindPopup(html);
        layer.addLayer(m);
        bounds.push([lat, lng]);
      });
      if (bounds.length) map.fitBounds(bounds, { padding:[40,40] });
    }

    async function boot(){
      initMap();
      try{
        const data = await loadData();
        const params = getParams();
        const filtered = FILTERS.applyFilters(data, params);
        $('count').textContent = `${filtered.length} result${filtered.length===1?'':'s'}`;
        $('list-link').href = 'listings.html' + (location.search || '');
        renderWhy(params);
        updateMarkers(filtered);
        if (!filtered.length){
          map.setView([49.2827, -123.1207], 10);
        }
      }catch(e){
        console.error(e);
        $('count').textContent = '0 results';
        $('why-body').textContent = 'Could not load mock data.';
      }
    }
    boot();
  </script>
  <script src="js/map-sidebar.js" defer></script>
</body>
</html>
