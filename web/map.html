<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <link rel="stylesheet" href="css/findr-theme.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Findr™ — Map</title>
  <meta name="description" content="Findr™ map view — mock listings with deterministic filters." />
  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <!-- JUNIPER START: CLUSTER CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <!-- JUNIPER END: CLUSTER CSS -->
  <style>
    :root { --brand:#5ea1ff; --bg:#0b0f17; --fg:#e8eef7; --muted:#9fb0c9; --card:rgba(255,255,255,0.04); --stroke:#223148; --surface:#0f1624; --chip:#1a2335; --chip-border:#2a3c5a; }
    :root[data-theme="light"]{ --bg:#f7f9fc; --fg:#0e1420; --muted:#5a6c85; --card:#ffffff; --stroke:#e5ecf5; --surface:#ffffff; --chip:#f1f4f8; --chip-border:#e5ecf5; }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg)}
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 20px}

    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{font-weight:900}
    .navlinks{display:flex; align-items:center; gap:14px}
    .navlinks a{padding:8px 10px; border-radius:10px}
    .navlinks a.active{background:var(--card); border:1px solid var(--stroke)}
    .toggle{cursor:pointer; border:1px solid var(--stroke); background:var(--card); color:var(--fg); border-radius:10px; padding:8px 10px}

    .panel{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:14px; margin-bottom:14px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .muted{color:var(--muted)}
    details#why summary{cursor:pointer; color:var(--muted)}

    #map{height:72vh; width:100%; border-radius:16px; border:1px solid var(--stroke); overflow:hidden}
    .leaflet-popup-content { margin: 10px 14px; }
    .price{font-weight:900}
    .addr{font-weight:800}
    .meta{color:var(--muted); font-size:12px}
  </style>

  <style id="findr-theme-enforce">
    :root{ --brand:#ffbc00 !important; --bg:#0d0d0d !important; --fg:#f4f4f4 !important; --muted:#a0a0a0 !important; --card:#1a1a1a !important; --stroke:#2a2a2a !important; --surface:#0f0f0f !important; }
    :root[data-theme="light"]{ --bg:#f9fafb !important; --fg:#111111 !important; --muted:#6b7280 !important; --card:#ffffff !important; --stroke:#e5e7eb !important; --surface:#ffffff !important; }
  </style>


  <style id="findr-map-grid-layout">
    .map-layout{display:grid;grid-template-columns:380px minmax(0,1fr);gap:24px;align-items:start}
    @media (max-width: 1024px){ .map-layout{grid-template-columns:1fr} }
    #findr-sidebar{background:var(--surface);color:var(--fg);border:1px solid var(--stroke);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    #findr-sidebar .sidebar-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--stroke)}
    #findr-sidebar .sidebar-title{font-size:16px;margin:0}
    #findr-sidebar .sidebar-form{padding:12px 14px}
    #findr-sidebar .row{display:flex;gap:10px}
    #findr-sidebar .field{display:flex;flex-direction:column;gap:4px;margin:8px 0;flex:1}
    #findr-sidebar .field input,#findr-sidebar .field select{padding:8px 10px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);color:var(--fg)}
    #findr-sidebar .actions{display:flex;gap:8px;margin-top:10px}
    #findr-sidebar .btn-primary{padding:8px 12px;border-radius:10px;background:var(--brand);border:1px solid var(--stroke);color:#111;font-weight:700;cursor:pointer}
    #findr-sidebar .btn-secondary{padding:8px 12px;border-radius:10px;background:var(--card);border:1px solid var(--stroke);color:var(--fg);cursor:pointer}
    #findr-sidebar .help{color:var(--muted);font-size:12px;margin:8px 0 12px}
    #findr-sidebar .top-card{border-top:1px solid var(--stroke);padding:12px 14px}
    #findr-sidebar .listing-card{display:grid;grid-template-columns:96px 1fr;gap:10px;align-items:center;border:1px solid var(--stroke);border-radius:12px;padding:10px;background:var(--card);margin-bottom:10px}
    #findr-sidebar .listing-card img{width:96px;height:72px;object-fit:cover;border-radius:10px}
    #findr-sidebar .listing-card .meta{display:flex;flex-direction:column;gap:2px}
    .map-main{display:flex;flex-direction:column;gap:14px}
  </style>

</head>
<body>
  <div class="wrap">
    <!-- Nav -->
    <nav class="nav" role="navigation" aria-label="Primary">
      <div class="brand"><div class="logo" aria-label="Findr home">Findr™</div></div>
      <div class="navlinks">
        <a href="/">Home</a>
        <a href="listings.html">Listings</a>
        <a href="map.html" class="active" aria-current="page">Map</a>
        <button id="theme-toggle" class="toggle" type="button" aria-label="Toggle theme">🌙</button>
      </div>
    </nav>

    
    <section class="map-layout">
      <aside id="findr-sidebar" aria-label="Filters panel">
        <div class="sidebar-header"><h2 class="sidebar-title">Filters</h2></div>
        <form id="findr-filter-form" class="sidebar-form" aria-describedby="findr-filter-help">
          <div class="field"><label for="city">City</label><select id="city" name="city" aria-label="City">
            <option value="">Any</option>
            <option>Burnaby</option><option>Coquitlam</option><option>Port Coquitlam</option><option>Port Moody</option>
            <option>Maple Ridge</option><option>Pitt Meadows</option><option>Langley</option><option>Surrey</option><option>Vancouver</option>
          </select></div>
          <div class="row">
            <div class="field"><label for="beds">Beds (min)</label><select id="beds" name="beds"><option value="">Any</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
            <div class="field"><label for="baths">Baths (min)</label><select id="baths" name="baths"><option value="">Any</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
          </div>
          <div class="row">
            <div class="field"><label for="minp">Min Price</label><input id="minp" name="minp" type="number" inputmode="numeric" placeholder="300000" /></div>
            <div class="field"><label for="maxp">Max Price</label><input id="maxp" name="maxp" type="number" inputmode="numeric" placeholder="2500000" /></div>
          </div>
          <div class="row">
            <div class="field"><label for="type">Type</label><select id="type" name="type"><option value="">Any</option><option>Condo</option><option>Townhouse</option><option>House</option></select></div>
            <div class="field"><label for="sort">Sort</label><select id="sort" name="sort"><option value="relevance">Relevance</option><option value="price-asc">Price ↑</option><option value="price-desc">Price ↓</option><option value="beds-desc">Beds ↓</option><option value="baths-desc">Baths ↓</option></select></div>
          </div>
          <div class="actions"><button type="button" id="findr-apply" class="btn-primary">Apply</button><button type="button" id="findr-clear" class="btn-secondary">Clear</button></div>
          <p id="findr-filter-help" class="help">Filters update the map without reloading the page.</p>
        </form>
        <div class="top-card" aria-live="polite" aria-label="Top listings">
          <h3>Top Picks</h3>
          <div id="findr-top-card"></div>
        </div>
      </aside>
      <div class="map-main">
<!-- Summary -->
    <div class="panel">
      <div class="row">
        <div class="muted" id="count" aria-live="polite">Loading…</div>
        <div class="muted"><a id="list-link" href="listings.html" aria-label="View as a list">Switch to list →</a></div>
      </div>
      <details id="why">
        <summary>Why these results?</summary>
        <div id="why-body" class="muted" style="margin-top:6px;"></div>
      </details>
    </div>

    <!-- Map -->
    <div id="map" role="region" aria-label="Map of listings"></div>
      </div>
    </section>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- JUNIPER START: CLUSTER JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <!-- JUNIPER END: CLUSTER JS -->
  <script src="config.js"></script>
  <script src="js/ai-guard.js"></script>
  <script src="js/filters.js"></script>
  <script>
    // Theme toggle
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('theme');
      if (saved) root.setAttribute('data-theme', saved);
      const btn = document.getElementById('theme-toggle');
      const isDark = () => root.getAttribute('data-theme') !== 'light';
      const render = () => { if(btn) btn.textContent = isDark() ? '🌙' : '☀️'; };
      if (btn) {
        btn.addEventListener('click', () => {
          root.setAttribute('data-theme', isDark() ? 'light' : 'dark');
          localStorage.setItem('theme', root.getAttribute('data-theme'));
          render();
        });
      }
      render();
    })();

    // Helpers
    const $ = (id) => document.getElementById(id);
    const fmtPrice = (n) => new Intl.NumberFormat('en-CA', { style:'currency', currency:'CAD', maximumFractionDigits:0 }).format(n);

    function getParams(){
      const p = new URLSearchParams(location.search);
      return {
        q: p.get('q') || '',
        city: p.get('city') || '',
        beds: p.get('beds') || '',
        baths: p.get('baths') || '',
        minp: p.get('minp') || '',
        maxp: p.get('maxp') || ''
      };
    }

    function renderWhy(params){
      const parts=[];
      if (params.q) parts.push(`Text: “${params.q}”`);
      if (params.city) parts.push(params.city);
      if (params.beds) parts.push(`${params.beds}+ bed`);
      if (params.baths) parts.push(`${params.baths}+ bath`);
      const left = params.minp ? fmtPrice(+params.minp) : 'Any';
      const right = params.maxp ? fmtPrice(+params.maxp) : 'Any';
      if (params.minp || params.maxp) parts.push(`Price: ${left}–${right}`);
      $('why-body').textContent = parts.length ? parts.join(' · ') : 'No active filters (all listings).';
    }

    // Load data from multiple candidate paths (same as listings page)
    async function loadData(){
      const candidates = ['/data/listings.json','data/listings.json','/listings.json','listings.json'];
      for (const url of candidates){
        try{ const res = await fetch(url,{cache:'no-store'}); if(res.ok) return await res.json(); }catch(_e){}
      }
      throw new Error('Could not load listings.json from expected paths.');
    }

    // Map + markers (use clustering; normalize lon→lng)
    var map, layer; // JUNIPER: var so they're globals (needed by some add-ons)

    function setParamsInUrl(params){
      const u = new URL(location.href);
      Object.keys(params).forEach(k => {
        if (params[k] === '' || params[k] == null) u.searchParams.delete(k);
        else u.searchParams.set(k, params[k]);
      });
      history.replaceState(null,'',u.toString());
    }
    function cardHTML(row){
      if (!row) return '';
      const img = row.photo || 'assets/placeholder-real-estate-dark.svg';
      const price = fmtPrice(+row.price) || '$—';
      const meta = [row.beds + ' bd', row.baths + ' ba', (row.type||'')].filter(Boolean).join(' • ');
      const brokerage = row.brokerage || '—';
      
      return [
        '<div class="listing-card">',
        '  <img src="'+img+'" alt="Listing photo for '+(row.address||'')+'">',
        '  <div class="meta">',
        '    <strong>'+price+'</strong>',
        '    <span>'+(row.address||'')+'</span>',
        '    <span>'+meta+'</span>',
        '    <span style="font-size:12px;color:var(--muted)">'+brokerage+' • <span style="border:1px solid var(--stroke);padding:2px 6px;border-radius:8px;background:var(--card)">REALTOR.ca</span> • <em>source: mock</em></span>',
        '  </div>',
        '</div>'
      ].join('');
    }
    function renderTopList(rows){
      const host = document.getElementById('findr-top-card');
      if (!host) return;
      if (!rows || !rows.length){ host.innerHTML = '<p class="help">No results match the current filters.</p>'; return;}
      host.innerHTML = rows.slice(0,3).map(cardHTML).join('');
    }

    function initMap(){
      map = L.map('map', { scrollWheelZoom: true });
      const dark = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
      L.tileLayer(dark, { attribution: '&copy; OpenStreetMap' }).addTo(map);
      map.setView([49.2827, -123.1207], 11);

      // JUNIPER: create cluster group up-front (fast for 500–1,000 markers)
      layer = L.markerClusterGroup({
        maxClusterRadius: 60,
        spiderfyOnMaxZoom: true,
        chunkedLoading: true
      }).addTo(map);
    }

    function updateMarkers(list){
      layer.clearLayers();
      if (!list || !list.length) return;

      const bounds = [];
      list.forEach(it=>{
        // normalize lon->lng so markers render regardless of key used in JSON
        const lat = (typeof it.lat === 'number') ? it.lat : null;
        const lng = (typeof it.lng === 'number') ? it.lng : (typeof it.lon === 'number' ? it.lon : null);
        if (typeof lat !== 'number' || typeof lng !== 'number') return;

        const html = `
          <div class="addr">${it.address}</div>
          <div class="price">${fmtPrice(it.price)}</div>
          <div class="meta">${it.city} · ${it.beds} bd · ${it.baths} ba</div>
          <div style="margin-top:8px;">
            <a href="${it.realtorca_url}" target="_blank" rel="noopener">View on REALTOR.ca →</a>
          </div>`;
        const m = L.marker([lat, lng]).bindPopup(html);
        layer.addLayer(m);
        bounds.push([lat, lng]);
      });
      if (bounds.length) map.fitBounds(bounds, { padding:[40,40] });
    }

    async function boot(){
      initMap();
      try{
        const data = await loadData();
        const params = getParams();
        const filtered = FILTERS.applyFilters(data, params);
        $('count').textContent = `${filtered.length} result${filtered.length===1?'':'s'}`;
        $('list-link').href = 'listings.html' + (location.search || '');
        renderWhy(params);
        updateMarkers(filtered);
        try { renderTopList(filtered.length ? filtered : data.sort(()=>Math.random()-0.5)); } catch(_e) {}
        if (!filtered.length){
          map.setView([49.2827, -123.1207], 10);
        }
      }catch(e){
        console.error(e);
        $('count').textContent = '0 results';
        $('why-body').textContent = 'Could not load mock data.';
      }
    }
    boot();

    document.addEventListener('DOMContentLoaded', function(){
      // Prefill from URL
      const p = new URLSearchParams(location.search);
      ['city','beds','baths','minp','maxp','type','sort'].forEach(id => { const el = document.getElementById(id); if (el && p.get(id)) el.value = p.get(id); });
      const apply = document.getElementById('findr-apply');
      const clear = document.getElementById('findr-clear');
      function recompute(){
        if (!window.__FINDR_DATA) return;
        const params = {
          q: p.get('q')||'',
          city: document.getElementById('city').value || '',
          beds: document.getElementById('beds').value || '',
          baths: document.getElementById('baths').value || '',
          minp: document.getElementById('minp').value || '',
          maxp: document.getElementById('maxp').value || '',
          type: document.getElementById('type').value || '',
          sort: document.getElementById('sort').value || 'relevance'
        };
        setParamsInUrl(params);
        const filtered = (window.FILTERS && FILTERS.applyFilters) ? FILTERS.applyFilters(window.__FINDR_DATA, params) : window.__FINDR_DATA;
        document.getElementById('count').textContent = `${filtered.length} result${filtered.length===1?'':'s'}`;
        renderWhy(params);
        updateMarkers(filtered);
        renderTopList(filtered.length ? filtered : window.__FINDR_DATA.sort(()=>Math.random()-0.5));
      }
      if (apply) apply.addEventListener('click', recompute);
      if (clear) clear.addEventListener('click', function(){
        ['city','beds','baths','minp','maxp','type','sort'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        recompute();
      });
    });

  </script>
</body>
</html>
