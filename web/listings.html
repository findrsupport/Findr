<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Findr™ · Listings</title>
  <meta name="description" content="Findr™ — clean, compliant real-estate search. Deterministic filters.">
  <link rel="preload" href="/web/data/listings.json" as="fetch" crossorigin="anonymous" />
  <style>
    :root {
      --brand: #7cc5ff;
      --bg: #0b0f13;
      --fg: #e8eef5;
      --muted: #9fb2c3;
      --card: #131920;
      --stroke: #273140;
      --surface: #0f141a;
    }
    [data-theme="light"] {
      --bg: #ffffff;
      --fg: #1a2430;
      --muted: #516171;
      --card: #f7f9fb;
      --stroke: #d9e0e7;
      --surface: #ffffff;
    }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.4;
    }
    a { color: var(--brand); text-decoration: none; }
    a:focus-visible, button:focus-visible, select:focus-visible, input:focus-visible {
      outline: 2px solid var(--brand);
      outline-offset: 2px;
      border-radius: 6px;
    }
    header {
      border-bottom: 1px solid var(--stroke);
      background: var(--surface);
      position: sticky; top: 0; z-index: 10;
    }
    .wrap { max-width: 1080px; margin: 0 auto; padding: 16px; }
    .nav {
      display: flex; align-items: center; gap: 16px; justify-content: space-between;
    }
    .nav-left, .nav-right { display: flex; gap: 12px; align-items: center; }
    .brand { font-weight: 700; letter-spacing: .3px; }
    .pill { padding: 8px 12px; border: 1px solid var(--stroke); border-radius: 10px; background: var(--card); color: var(--fg); }
    main .filters { display: grid; gap: 12px; grid-template-columns: 1fr; margin-top: 16px; }
    @media (min-width: 780px) {
      main .filters { grid-template-columns: 1.2fr .9fr .9fr .9fr .9fr .9fr; }
    }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"], select {
      width: 100%; padding: 10px 12px; background: var(--card); color: var(--fg);
      border: 1px solid var(--stroke); border-radius: 10px;
    }
    button { cursor: pointer; }
    .btn {
      padding: 10px 12px; border-radius: 10px; border: 1px solid var(--stroke);
      background: var(--card); color: var(--fg);
    }
    .btn.brand { background: var(--brand); color: #0b0f13; border-color: transparent; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 14px 0; }
    .chip {
      display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; font-size: 13px;
      background: var(--card); border: 1px solid var(--stroke); border-radius: 999px;
    }
    .chip button { border: none; background: transparent; color: var(--muted); padding: 0; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 780px) { .row { grid-template-columns: 1fr auto; align-items: center; } }
    .result-meta { color: var(--muted); font-size: 14px; }
    .why {
      border: 1px solid var(--stroke); border-radius: 12px; background: var(--surface);
      padding: 12px; margin-top: 8px;
    }
    .grid {
      display: grid; gap: 14px; margin-top: 14px;
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 640px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
    @media (min-width: 980px) { .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .card {
      border: 1px solid var(--stroke); border-radius: 14px; overflow: clip; background: var(--card);
      display: flex; flex-direction: column;
    }
    .thumb { width: 100%; height: 168px; object-fit: cover; background: #000; }
    .card-body { padding: 12px; display: grid; gap: 6px; }
    .meta { color: var(--muted); font-size: 13px; }
    .compliance {
      margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--stroke);
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .badge { display: inline-flex; align-items: center; gap: 8px; }
    .badge img { height: 20px; width: auto; }
    footer {
      border-top: 1px solid var(--stroke); margin-top: 24px; padding: 16px 0; color: var(--muted);
      font-size: 12px; background: var(--surface);
    }
    .sr-only { position: absolute !important; width: 1px; height: 1px; margin: -1px; border: 0; padding: 0; white-space: nowrap; clip-path: inset(50%); clip: rect(0 0 0 0); overflow: hidden; }
  </style>
</head>
<body>
  <header role="banner">
    <div class="wrap nav" aria-label="Primary">
      <div class="nav-left">
        <div class="brand" aria-label="Findr brand">Findr™</div>
        <nav role="navigation" aria-label="Main">
          <a class="pill" href="/web/index.html">Home</a>
          <a class="pill" href="/web/listings.html" aria-current="page">Listings</a>
          <a class="pill" href="/web/map.html">Map</a>
        </nav>
      </div>
      <div class="nav-right">
        <button id="themeToggle" class="pill" aria-pressed="false" aria-label="Toggle light or dark theme">Toggle</button>
      </div>
    </div>
  </header>

  <main class="wrap" role="main">
    <h1 style="margin-top:12px">Listings</h1>

    <!-- Smart search -->
    <div class="filters" style="margin-top:8px" role="search" aria-label="Smart listing search">
      <div>
        <label for="smartText">Smart (plain-English → filters)</label>
        <input id="smartText" type="text" inputmode="search" autocomplete="off"
               placeholder="e.g., 2 bed under 900k in Burnaby" aria-describedby="smart-desc" />
        <p id="smart-desc" class="sr-only">
          Your text is converted to structured filters only. AI never reads listing data.
        </p>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="smartBtn" class="btn brand" aria-label="Apply Smart search">Smart</button>
      </div>
      <!-- Controls -->
      <div>
        <label for="citySel">City</label>
        <select id="citySel" aria-label="City"></select>
      </div>
      <div>
        <label for="bedsSel">Beds (min)</label>
        <select id="bedsSel" aria-label="Minimum bedrooms">
          <option value="">Any</option>
          <option value="1">1+</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
          <option value="5">5+</option>
        </select>
      </div>
      <div>
        <label for="bathsSel">Baths (min)</label>
        <select id="bathsSel" aria-label="Minimum bathrooms">
          <option value="">Any</option>
          <option value="1">1+</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
          <option value="5">5+</option>
        </select>
      </div>
      <div>
        <label for="minSel">Min price</label>
        <select id="minSel" aria-label="Minimum price">
          <option value="">Any</option>
          <option value="300000">$300k</option>
          <option value="400000">$400k</option>
          <option value="500000">$500k</option>
          <option value="600000">$600k</option>
          <option value="700000">$700k</option>
          <option value="800000">$800k</option>
          <option value="900000">$900k</option>
          <option value="1000000">$1.0M</option>
          <option value="1250000">$1.25M</option>
          <option value="1500000">$1.5M</option>
          <option value="1750000">$1.75M</option>
          <option value="2000000">$2.0M</option>
          <option value="2500000">$2.5M</option>
        </select>
      </div>
      <div>
        <label for="maxSel">Max price</label>
        <select id="maxSel" aria-label="Maximum price">
          <option value="">Any</option>
          <option value="300000">$300k</option>
          <option value="400000">$400k</option>
          <option value="500000">$500k</option>
          <option value="600000">$600k</option>
          <option value="700000">$700k</option>
          <option value="800000">$800k</option>
          <option value="900000">$900k</option>
          <option value="1000000">$1.0M</option>
          <option value="1250000">$1.25M</option>
          <option value="1500000">$1.5M</option>
          <option value="1750000">$1.75M</option>
          <option value="2000000">$2.0M</option>
          <option value="2500000">$2.5M</option>
        </select>
      </div>
      <div>
        <label for="sortSel">Sort</label>
        <select id="sortSel" aria-label="Sort results">
          <option value="relevance">Relevance</option>
          <option value="price-asc">Price ↑</option>
          <option value="price-desc">Price ↓</option>
          <option value="beds-desc">Beds ↓</option>
          <option value="baths-desc">Baths ↓</option>
        </select>
      </div>
    </div>

    <!-- Chips + meta -->
    <div class="row" style="margin-top:8px">
      <div class="chips" id="chips" aria-label="Active filters"></div>
      <div class="result-meta">
        <span id="resultCount" aria-live="polite"></span>
      </div>
    </div>

    <!-- Why these results -->
    <details id="whyBox" class="why" aria-live="polite">
      <summary><strong>Why these results?</strong></summary>
      <div id="whyText" style="margin-top:6px; font-size:14px; color:var(--muted)"></div>
    </details>

    <!-- Results grid -->
    <section id="grid" class="grid" aria-label="Listings"></section>
  </main>

  <footer role="contentinfo">
    <div class="wrap">
      The trademarks REALTOR®, REALTORS®, and the REALTOR® logo are controlled by The Canadian Real Estate Association (CREA)
      and identify real estate professionals who are members of CREA. The trademarks MLS®, Multiple Listing Service® and the
      associated logos are owned by CREA and identify the quality of services provided by real estate professionals who are
      members of CREA.
    </div>
  </footer>

  <!-- Config & shared guards / filters (do not expose keys here) -->
  <script src="/web/config.js"></script>
  <script src="/web/js/ai-guard.js"></script>
  <script src="/web/js/filters.js"></script>
  <!-- Optional demo fallback if serverless intent is unavailable -->
  <script src="/web/js/ai-demo.js" defer></script>

  <script>
  (function() {
    /** Theme toggle (persisted) */
    const themeToggle = document.getElementById('themeToggle');
    const root = document.documentElement;
    const storedTheme = localStorage.getItem('findr_theme');
    if (storedTheme === 'light' || storedTheme === 'dark') {
      root.setAttribute('data-theme', storedTheme);
      themeToggle.setAttribute('aria-pressed', storedTheme === 'dark' ? 'true' : 'false');
    } else {
      root.setAttribute('data-theme', 'dark');
      themeToggle.setAttribute('aria-pressed', 'true');
    }
    themeToggle.addEventListener('click', () => {
      const current = root.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.setItem('findr_theme', next);
      themeToggle.setAttribute('aria-pressed', next === 'dark' ? 'true' : 'false');
    });

    /* Elements */
    const citySel  = document.getElementById('citySel');
    const bedsSel  = document.getElementById('bedsSel');
    const bathsSel = document.getElementById('bathsSel');
    const minSel   = document.getElementById('minSel');
    const maxSel   = document.getElementById('maxSel');
    const sortSel  = document.getElementById('sortSel');

    const smartText = document.getElementById('smartText');
    const smartBtn  = document.getElementById('smartBtn');

    const chips = document.getElementById('chips');
    const grid  = document.getElementById('grid');
    const resultCount = document.getElementById('resultCount');
    const whyBox  = document.getElementById('whyBox');
    const whyText = document.getElementById('whyText');

    /* URL params → object */
    const params = new URLSearchParams(location.search);
    function getParams() {
      return {
        q: params.get('q') || '',
        city: params.get('city') || '',
        beds: toNum(params.get('beds')),
        baths: toNum(params.get('baths')),
        minp: toNum(params.get('minp')),
        maxp: toNum(params.get('maxp')),
        sort: params.get('sort') || 'relevance'
      };
    }
    function setParams(p) {
      const next = new URLSearchParams();
      if (p.q) next.set('q', p.q);
      if (p.city) next.set('city', p.city);
      if (p.beds != null && p.beds !== '') next.set('beds', String(p.beds));
      if (p.baths != null && p.baths !== '') next.set('baths', String(p.baths));
      if (p.minp != null && p.minp !== '') next.set('minp', String(p.minp));
      if (p.maxp != null && p.maxp !== '') next.set('maxp', String(p.maxp));
      if (p.sort && p.sort !== 'relevance') next.set('sort', p.sort);
      const url = location.pathname + (next.toString() ? '?' + next.toString() : '');
      history.replaceState(null, '', url);
    }
    function toNum(v) { return v == null || v === '' ? null : Number(v); }

    /* Data */
    let ALL = [];
    fetch('/web/data/listings.json', { credentials: 'same-origin' })
      .then(r => r.json())
      .then(json => {
        ALL = Array.isArray(json) ? json : [];
        hydrateCities(ALL);
        hydrateControlsFromParams();
        render();
      })
      .catch(() => {
        grid.innerHTML = '<p role="alert">Failed to load listings.</p>';
      });

    function hydrateCities(list) {
      const set = new Set(list.map(x => x.city).filter(Boolean));
      const cities = Array.from(set).sort();
      citySel.innerHTML = '<option value="">Any</option>' + cities.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }
    function hydrateControlsFromParams() {
      const p = getParams();
      if (p.city)  citySel.value = p.city;
      if (p.beds)  bedsSel.value = String(p.beds);
      if (p.baths) bathsSel.value = String(p.baths);
      if (p.minp)  minSel.value  = String(p.minp);
      if (p.maxp)  maxSel.value  = String(p.maxp);
      sortSel.value = p.sort || 'relevance';
    }

    /* Filtering via shared deterministic filters if available; fallback if not */
    function applyFilters(all, p) {
      let out = all.slice();
      const F = (window.FindrFilters && (window.FindrFilters.apply || window.FindrFilters.filter)) || null;

      if (F) {
        // Support either .apply(list, params) or .filter(list, params)
        out = (window.FindrFilters.apply || window.FindrFilters.filter)(out, p);
        if (window.FindrFilters.sort && p.sort) out = window.FindrFilters.sort(out, p.sort);
      } else {
        // Strict deterministic fallback
        if (p.city) out = out.filter(x => x.city === p.city);
        if (p.beds != null) out = out.filter(x => Number(x.beds) >= p.beds);
        if (p.baths != null) out = out.filter(x => Number(x.baths) >= p.baths);
        if (p.minp != null) out = out.filter(x => Number(x.price) >= p.minp);
        if (p.maxp != null) out = out.filter(x => Number(x.price) <= p.maxp);
        // sort fallback
        out = sortLocal(out, p.sort);
      }
      return out;
    }
    function sortLocal(arr, key) {
      const a = arr.slice();
      if (key === 'price-asc') a.sort((x,y)=>x.price-y.price);
      else if (key === 'price-desc') a.sort((x,y)=>y.price-x.price);
      else if (key === 'beds-desc') a.sort((x,y)=>y.beds-x.beds || y.price-x.price);
      else if (key === 'baths-desc') a.sort((x,y)=>y.baths-x.baths || y.price-x.price);
      return a;
    }

    /* Render */
    function render() {
      const p = {
        q: '',
        city: citySel.value || '',
        beds: valNum(bedsSel.value),
        baths: valNum(bathsSel.value),
        minp: valNum(minSel.value),
        maxp: valNum(maxSel.value),
        sort: sortSel.value || 'relevance'
      };
      setParams(p);

      const filtered = applyFilters(ALL, p);
      resultCount.textContent = `${filtered.length} result${filtered.length === 1 ? '' : 's'}`;
      renderChips(p);
      renderWhy(p);
      renderGrid(filtered);
    }

    function renderGrid(list) {
      if (!list.length) {
        grid.innerHTML = `<p role="status">No results. Try widening your filters.</p>`;
        return;
      }
      grid.innerHTML = list.map(cardHTML).join('');
    }

    function cardHTML(x) {
      const price = formatPrice(x.price);
      const addr = escapeHtml(x.address || '');
      const city = escapeHtml(x.city || '');
      const beds = Number(x.beds ?? 0);
      const baths = Number(x.baths ?? 0);
      const photo = escapeHtml(x.photo || '');
      const brokerage = escapeHtml(x.brokerage || 'Brokerage');
      const rurl = escapeHtml(x.realtorca_url || '#');

      return `
        <article class="card" aria-label="${addr}, ${city}">
          <img class="thumb" src="${photo}" alt="Listing photo: ${addr}" loading="lazy">
          <div class="card-body">
            <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
              <h3 style="margin:0; font-size:16px">${price}</h3>
              <span class="meta">${beds} bd · ${baths} ba</span>
            </div>
            <div class="meta">${addr}${city ? `, ${city}` : ''}</div>
            <div class="compliance">
              <div class="meta" aria-label="Listing brokerage">Listing Brokerage: <strong>${brokerage}</strong></div>
              <a class="badge" href="${rurl}" target="_blank" rel="noopener" aria-label="View on REALTOR.ca">
                <img src="https://static.realtor.ca/branding/powered-by-realtorca.svg" alt="Powered by REALTOR.ca">
              </a>
            </div>
          </div>
        </article>
      `;
    }

    function renderChips(p) {
      const chipEls = [];
      if (p.city) chipEls.push(makeChip('City: ' + p.city, () => { citySel.value=''; render(); }));
      if (p.beds) chipEls.push(makeChip(`Beds: ${p.beds}+`, () => { bedsSel.value=''; render(); }));
      if (p.baths) chipEls.push(makeChip(`Baths: ${p.baths}+`, () => { bathsSel.value=''; render(); }));
      if (p.minp) chipEls.push(makeChip(`Min: ${formatShort(p.minp)}`, () => { minSel.value=''; render(); }));
      if (p.maxp) chipEls.push(makeChip(`Max: ${formatShort(p.maxp)}`, () => { maxSel.value=''; render(); }));

      // New: Reset price (only if either min or max is set)
      if (p.minp || p.maxp) {
        chipEls.push(`
          <span class="chip" role="button" tabindex="0" aria-label="Reset price range">
            Reset price
          </span>
        `);
      }

      // Utility chips
      chipEls.push(`
        <span class="chip" role="button" tabindex="0" aria-label="Copy link" id="copyLinkChip">Copy link</span>
      `);
      chipEls.push(`
        <span class="chip" role="button" tabindex="0" aria-label="Clear all filters" id="clearAllChip">Clear all</span>
      `);

      chips.innerHTML = chipEls.join('');

      // Wire chip handlers
      chips.querySelectorAll('.chip').forEach(ch => {
        ch.addEventListener('keypress', (e) => { if (e.key === 'Enter' || e.key === ' ') ch.click(); });
      });

      const resetPrice = Array.from(chips.children).find(el => el.textContent.trim() === 'Reset price');
      if (resetPrice) {
        resetPrice.addEventListener('click', () => {
          minSel.value = ''; maxSel.value = ''; render();
        });
      }
      const copy = document.getElementById('copyLinkChip');
      if (copy) {
        copy.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(location.href);
            copy.textContent = 'Copied!';
            setTimeout(() => (copy.textContent = 'Copy link'), 1200);
          } catch {}
        });
      }
      const clear = document.getElementById('clearAllChip');
      if (clear) {
        clear.addEventListener('click', () => {
          citySel.value = bedsSel.value = bathsSel.value = minSel.value = maxSel.value = '';
          sortSel.value = 'relevance';
          render();
        });
      }
    }

    function renderWhy(p) {
      const clauses = [];
      if (p.city) clauses.push(`City is <strong>${escapeHtml(p.city)}</strong>`);
      if (p.beds) clauses.push(`at least <strong>${p.beds} bed${p.beds>1?'s':''}</strong>`);
      if (p.baths) clauses.push(`at least <strong>${p.baths} bath${p.baths>1?'s':''}</strong>`);
      if (p.minp) clauses.push(`price ≥ <strong>${formatPrice(p.minp)}</strong>`);
      if (p.maxp) clauses.push(`price ≤ <strong>${formatPrice(p.maxp)}</strong>`);
      const sortMap = {
        'relevance': 'default order',
        'price-asc': 'lowest price first',
        'price-desc': 'highest price first',
        'beds-desc': 'most bedrooms first',
        'baths-desc': 'most bathrooms first'
      };
      const sortTxt = sortMap[p.sort] || 'default order';
      const line = clauses.length ? ('Filtered by ' + clauses.join(', ') + `; sorted by <strong>${sortTxt}</strong>.`)
                                  : ('Showing all listings; sorted by <strong>'+sortTxt+'</strong>.');
      whyText.innerHTML = line + ' Smart search only converts your text to filters; it never reads listing data.';
    }

    // Smart intent
    smartBtn.addEventListener('click', async () => {
      const text = (smartText.value || '').trim();
      if (!text) return;
      try {
        const spec = await fetchIntent(text);
        applyFilterSpec(spec);
        smartText.value = ''; // clear free-text to avoid over-filtering
        whyBox.open = true;   // open explanation
        render();
      } catch (e) {
        // graceful fallback already handled in fetchIntent
      }
    });

    async function fetchIntent(text) {
      // Try serverless function first
      try {
        const r = await fetch('/.netlify/functions/intent', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (r.ok) return await r.json();
      } catch {}
      // Fallback to demo in-browser parser if present
      if (window.FindrDemoNLToFilters) {
        return window.FindrDemoNLToFilters(text);
      }
      // Last resort: empty spec
      return {
        min_price: null, max_price: null, beds_min: null, baths_min: null,
        property_types: null, areas: null, nearby: null, must_have: null,
        polygon: null, sort: 'relevance'
      };
    }

    function applyFilterSpec(spec) {
      // Map FilterSpec → controls; snap prices to nearest dropdown values.
      if (Array.isArray(spec.areas) && spec.areas[0]) {
        citySel.value = spec.areas[0];
      }
      if (spec.beds_min != null) bedsSel.value = String(spec.beds_min);
      if (spec.baths_min != null) bathsSel.value = String(spec.baths_min);

      const minSnap = snapToMenu(spec.min_price, minSel);
      const maxSnap = snapToMenu(spec.max_price, maxSel);
      minSel.value = minSnap ?? '';
      maxSel.value = maxSnap ?? '';

      if (spec.sort) sortSel.value = spec.sort;
    }

    function snapToMenu(value, selectEl) {
      if (value == null) return null;
      const nums = Array.from(selectEl.options)
        .map(o => o.value)
        .filter(v => v !== '')
        .map(v => Number(v))
        .sort((a,b)=>a-b);
      // Find nearest
      let best = nums[0], bestDiff = Math.abs(nums[0] - value);
      for (let i=1; i<nums.length; i++) {
        const d = Math.abs(nums[i] - value);
        if (d < bestDiff) { bestDiff = d; best = nums[i]; }
      }
      return String(best);
    }

    // Control events
    [citySel, bedsSel, bathsSel, minSel, maxSel, sortSel].forEach(el => {
      el.addEventListener('change', render);
    });

    // Helpers
    function valNum(v) { return v === '' ? null : Number(v); }
    function formatPrice(n) {
      if (n == null || isNaN(n)) return '$—';
      return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', maximumFractionDigits: 0 }).format(n);
    }
    function formatShort(n) {
      if (n >= 1_000_000) return '$' + (n/1_000_000).toFixed(n % 1_000_000 === 0 ? 0 : 2) + 'M';
      if (n >= 1_000) return '$' + Math.round(n/1000) + 'k';
      return '$' + String(n);
    }
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }
  })();
  </script>
</body>
</html>
