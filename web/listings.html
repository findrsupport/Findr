<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="css/findr-theme.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Findr‚Ñ¢ ‚Äî Listings</title>
  <meta name="description" content="Findr‚Ñ¢ mock listings ‚Äî compliant layout with filters and search." />
  <style>
    :root { --brand:#5ea1ff; --bg:#0b0f17; --fg:#e8eef7; --muted:#9fb0c9; --card:rgba(255,255,255,0.04); --stroke:#223148; --surface:#0f1624; --chip:#1a2335; --chip-border:#2a3c5a; }
    :root[data-theme="light"]{ --bg:#f7f9fc; --fg:#0e1420; --muted:#5a6c85; --card:#ffffff; --stroke:#e5ecf5; --surface:#ffffff; --chip:#f1f4f8; --chip-border:#e5ecf5; }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg)}
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 20px}

    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{font-weight:900}
    .navlinks{display:flex; align-items:center; gap:14px}
    .navlinks a{padding:8px 10px; border-radius:10px}
    .navlinks a.active{background:var(--card); border:1px solid var(--stroke)}
    .toggle{cursor:pointer; border:1px solid var(--stroke); background:var(--card); color:var(--fg); border-radius:10px; padding:8px 10px}

    .panel{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:14px}
    .toolbar{display:grid; grid-template-columns:1.6fr repeat(5, minmax(120px, 0.5fr)) 1fr; gap:10px; align-items:center}
    @media (max-width: 900px){ .toolbar{grid-template-columns:1fr 1fr 1fr; grid-auto-rows:minmax(40px,auto)} }
    .searchbox{display:flex; gap:8px}
    input[type="search"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--surface); color:var(--fg); font:inherit}
    .smart{white-space:nowrap; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--card); color:var(--fg); cursor:pointer}

    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); margin-top:14px}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; transition:transform .15s ease, box-shadow .2s ease}
    .card:hover{ transform:translateY(-2px); box-shadow:0 6px 28px rgba(0,0,0,.25) }
    .img{aspect-ratio:4/3; width:100%; object-fit:cover; background:#0a0f18}
    .content{padding:14px}
    .addr{font-weight:800; line-height:1.25}
    .price{font-weight:900}
    .meta{display:flex; gap:10px; font-size:12px; color:var(--muted); margin:6px 0 10px}

    .actions{display:flex; justify-content:space-between; align-items:center; gap:12px; background:var(--surface); margin-top:auto; padding:16px 18px; border-top:1px solid var(--stroke); flex-wrap:wrap}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:var(--chip); border:1px solid var(--chip-border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    .back{font-size:12px; margin-top:18px; color:var(--muted)}
    .muted{color:var(--muted)}
    details#why{margin-top:10px}
    details#why summary{cursor:pointer; color:var(--muted)}

    .row .addr{flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .row .price{flex:0 0 auto}

    .pbr-top{margin-top:6px}
    .pbr-top img{height:22px; width:auto}

    .agent{display:flex; align-items:center; gap:10px; min-width:0}
    .agent-avatar{width:40px; height:40px; border-radius:50%; background:var(--chip); border:1px solid var(--chip-border)}
    .agent-info{display:flex; flex-direction:column; gap:2px; min-width:0}
    .agent-name{font-weight:700; font-size:12px; line-height:1.2; color:var(--fg)}
    .agent-broker{font-size:12px; color:var(--muted); line-height:1.2}
    .actions-cta{display:flex; align-items:center; gap:10px; margin-left:auto}
    .contact-btn{display:inline-block; border:1px solid var(--stroke); background:var(--card); color:var(--fg); padding:8px 10px; border-radius:10px; text-decoration:none}

    .error{margin:12px 0; padding:12px; border:1px solid var(--stroke); border-radius:12px; background:var(--card); color:#ffb4b4}
  </style>

  <style id="findr-theme-enforce">
    :root{
      --brand:#ffbc00 !important;
      --bg:#0d0d0d !important;
      --fg:#f4f4f4 !important;
      --muted:#a0a0a0 !important;
      --card:#1a1a1a !important;
      --stroke:#2a2a2a !important;
      --surface:#0f0f0f !important;
    }
    :root[data-theme="light"]{
      --bg:#f9fafb !important;
      --fg:#111111 !important;
      --muted:#6b7280 !important;
      --card:#ffffff !important;
      --stroke:#e5e7eb !important;
      --surface:#ffffff !important;
    }
  </style>

</head>
<body>
  <div class="wrap">
    <nav class="nav" role="navigation" aria-label="Primary">
      <div class="brand"><div class="logo" aria-label="Findr home">Findr‚Ñ¢</div></div>
      <div class="navlinks">
        <a href="/">Home</a>
        <a href="listings.html" class="active" aria-current="page">Listings</a>
        <a href="map.html">Map</a>
        <button id="theme-toggle" class="toggle" type="button" aria-label="Toggle theme">üåô</button>
      </div>
    </nav>

    <div class="panel">
      <div class="toolbar" role="region" aria-label="Search and filters">
        <div class="searchbox">
          <input id="q" type="search" placeholder='Describe your... or click ‚ÄúSmart‚Äù' aria-label="Search or describe your needs" />
          <button id="smart-btn" class="smart" type="button" aria-label="Convert description to filters">Smart</button>
        </div>
        <select id="city" aria-label="City">
          <option value="">City (any)</option>
          <option>Vancouver</option><option>Burnaby</option><option>Richmond</option>
          <option>Surrey</option><option>Coquitlam</option><option>Port Moody</option>
          <option>Port Coquitlam</option><option>New Westminster</option>
          <option>Langley</option><option>Maple Ridge</option>
        </select>
        <select id="beds" aria-label="Minimum bedrooms">
          <option value="">Beds (any)</option>
          <option value="1">1+ bed</option><option value="2">2+ bed</option>
          <option value="3">3+ bed</option><option value="4">4+ bed</option>
          <option value="5">5+ bed</option>
        </select>
        <select id="baths" aria-label="Minimum bathrooms">
          <option value="">Baths (any)</option>
          <option value="1">1+ bath</option><option value="2">2+ bath</option>
          <option value="3">3+ bath</option><option value="4">4+ bath</option>
          <option value="5">5+ bath</option>
        </select>
        <select id="minp" aria-label="Min price">
          <option value="">Min price</option>
          <option value="250000">$250k</option><option value="400000">$400k</option>
          <option value="500000">$500k</option><option value="600000">$600k</option>
          <option value="750000">$750k</option><option value="1000000">$1.0M</option>
          <option value="1250000">$1.25M</option><option value="1500000">$1.5M</option>
          <option value="2000000">$2.0M</option>
        </select>
        <select id="maxp" aria-label="Max price">
          <option value="">Max price</option>
          <option value="400000">$400k</option><option value="500000">$500k</option>
          <option value="600000">$600k</option><option value="750000">$750k</option>
          <option value="1000000">$1.0M</option><option value="1250000">$1.25M</option>
          <option value="1500000">$1.5M</option><option value="2000000">$2.0M</option>
          <option value="3000000">$3.0M</option>
        </select>
        <select id="sort" aria-label="Sort">
          <option value="relevance">Sort: Relevance</option>
          <option value="price-asc">Price ‚Üë</option>
          <option value="price-desc">Price ‚Üì</option>
          <option value="beds-desc">Beds ‚Üì</option>
          <option value="baths-desc">Baths ‚Üì</option>
        </select>
      </div>

      <div class="row" style="margin:12px 0 10px">
        <div class="muted" id="count" aria-live="polite">Loading‚Ä¶</div>
        <div class="chips" id="chips" aria-live="polite"></div>
      </div>
      <details id="why">
        <summary>Why these results?</summary>
        <div id="why-body" class="muted" style="margin-top:6px;"></div>
      </details>
      <div id="err" class="error" role="status" aria-live="polite" style="display:none"></div>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>
    <p class="back"><a href="/">‚Üê Back to Home</a></p>
  </div>

  <!-- Config & libs -->
  <script src="config.js"></script>
  <script src="js/ai-guard.js"></script>
  <script src="js/filters.js"></script>
  <script src="js/ai-demo.js"></script>

  <script>
    // Theme: read from localStorage; default dark if none set
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('theme');
      root.setAttribute('data-theme', saved ? saved : 'dark'); // default dark
      const btn = document.getElementById('theme-toggle');
      const isDark = () => root.getAttribute('data-theme') !== 'light';
      const render = () => { if(btn) btn.textContent = isDark() ? 'üåô' : '‚òÄÔ∏è'; };
      if (btn) btn.addEventListener('click', () => {
        root.setAttribute('data-theme', isDark() ? 'light' : 'dark');
        localStorage.setItem('theme', root.getAttribute('data-theme'));
        render();
      });
      render();
    })();

    // Defensive shims so missing libs don't crash the page
    window.FindrAI = window.FindrAI || {
      withUserIntentGuard: async (text, fn) => fn(text),
      withListingAIGuard: async (listing, fn) => fn(listing)
    };
    window.AIDemo = window.AIDemo || {
      parseUserIntentDemo: async () => ({ min_price:null, max_price:null, beds_min:null, baths_min:null, areas:null, sort:'relevance' })
    };

    const $ = (id) => document.getElementById(id);
    const fmtPrice = (n) => new Intl.NumberFormat('en-CA', { style:'currency', currency:'CAD', maximumFractionDigits:0 }).format(n);
    let DATA=[], VIEW=[];

    function showErr(msg){
      console.error('[Findr listings error]', msg);
      const el = $('err');
      el.textContent = typeof msg === 'string' ? msg : (msg && msg.message) || 'Unexpected error';
      el.style.display = 'block';
    }

    function getParams(){
      const p = new URLSearchParams(location.search);
      return {
        q: p.get('q') || '',
        city: p.get('city') || '',
        beds: p.get('beds') || '',
        baths: p.get('baths') || '',
        minp: p.get('minp') || '',
        maxp: p.get('maxp') || '',
        sort: p.get('sort') || 'relevance'
      };
    }
    function setParams(){
      const p = new URLSearchParams();
      if($('q').value) p.set('q',$('q').value);
      if($('city').value) p.set('city',$('city').value);
      if($('beds').value) p.set('beds',$('beds').value);
      if($('baths').value) p.set('baths',$('baths').value);
      if($('minp').value) p.set('minp',$('minp').value);
      if($('maxp').value) p.set('maxp',$('maxp').value);
      if($('sort').value && $('sort').value!=='relevance') p.set('sort',$('sort').value);
      const newUrl = `${location.pathname}?${p.toString()}`;
      history.replaceState(null,'',newUrl);
    }

    function renderCount(){ $('count').textContent = `${VIEW.length} result${VIEW.length===1?'':'s'}`; }
    function renderWhy(){
      const parts=[];
      const q=$('q').value.trim(); if(q) parts.push(`Text: ‚Äú${q}‚Äù`);
      if($('city').value) parts.push($('city').value);
      if($('beds').value) parts.push(`${$('beds').value}+ bed`);
      if($('baths').value) parts.push(`${$('baths').value}+ bath`);
      const minp=$('minp').value, maxp=$('maxp').value;
      if(minp||maxp){
        const left=minp?fmtPrice(+minp):'Any', right=maxp?fmtPrice(+maxp):'Any';
        parts.push(`Price: ${left}‚Äì${right}`);
      }
      const s = $('sort').selectedOptions[0].text;
      if($('sort').value!=='relevance') parts.push(`Sort: ${s}`);
      $('why-body').textContent = parts.length ? parts.join(' ¬∑ ') : 'No active filters (all listings).';
    }

    function renderChips(){
      const chips = $('chips'); const active=[];
      const q=$('q').value.trim(); if(q) active.push({label:`Search: ‚Äú${q}‚Äù`, id:'q'});
      const city=$('city').value; if(city) active.push({label:city, id:'city'});
      const beds=$('beds').value; if(beds) active.push({label:`${beds}+ bed`, id:'beds'});
      const baths=$('baths').value; if(baths) active.push({label:`${baths}+ bath`, id:'baths'});
      const minp=$('minp').value, maxp=$('maxp').value;
      if(minp||maxp){ active.push({label:`${minp?fmtPrice(+minp):'Any'}‚Äì${maxp?fmtPrice(+maxp):'Any'}`, id:'price'}); active.push({label:'Reset price', id:'price-reset'}); }
      const sort=$('sort').value; if(sort!=='relevance') active.push({label:`Sort: ${$('sort').selectedOptions[0].text}`, id:'sort'});
      active.push({label:'Copy link', id:'copy'}); active.push({label:'Clear all', id:'clear'});

      chips.innerHTML = active.map(c=>`<button class="chip" data-id="${c.id}" type="button" aria-label="${c.label}">${c.label}${c.id!=='copy'&&c.id!=='clear'?' ‚úï':''}</button>`).join('');
      chips.querySelectorAll('.chip').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id');
        if(id==='copy'){ copyLink(b); return; }
        if(id==='clear'){ clearAll(); return; }
        if(id==='price-reset'){ $('minp').value=''; $('maxp').value=''; apply(); return; }
        if(id==='q') $('q').value='';
        if(id==='city') $('city').value='';
        if(id==='beds') $('beds').value='';
        if(id==='baths') $('baths').value='';
        if(id==='price'){ $('minp').value=''; $('maxp').value=''; }
        if(id==='sort') $('sort').value='relevance';
        apply();
      }));
    }

    function renderGrid(){
      const grid=$('grid'); grid.innerHTML='';
      VIEW.forEach(it=>{
        const el=document.createElement('article'); el.className='card';

        const subject = encodeURIComponent(`Inquiry about ${it.address}, ${it.city}`);
        const body = encodeURIComponent(`Hi,\nI'm interested in ${it.address}, ${it.city} listed at ${fmtPrice(it.price)}.\nListing: ${it.realtorca_url}\n\nSent via Findr`);
        const mailto = `mailto:?subject=${subject}&body=${body}`;

        const propType = (it.type || it.property_type || '').trim();
        const typePart = propType ? `<span>${propType}</span><span>‚Ä¢</span>` : '';

        el.innerHTML=`
          <img class="img"
               src="${it.photo}"
               alt="Photo of ${it.address}, ${it.city}"
               loading="lazy"
               decoding="async"
               referrerpolicy="no-referrer"
               onerror="this.onerror=null; this.src='assets/placeholder-real-estate.svg';">
          <div class="content">
            <div class="row"><div class="addr">${it.address}</div><div class="price">${fmtPrice(it.price)}</div></div>
            <div class="meta">
              ${typePart}
              <span>${it.city}</span><span>‚Ä¢</span>
              <span>${it.beds} ${it.beds===1?'bedroom':'bedrooms'}</span><span>‚Ä¢</span>
              <span>${it.baths} ${it.baths===1?'bathroom':'bathrooms'}</span>
            </div>
            <div class="pbr-top">
              <a class="pbr-badge" href="${it.realtorca_url}" target="_blank" rel="noopener" aria-label="View on REALTOR.ca">
                <img src="assets/powered-by-realtor.svg" alt="Powered by REALTOR.ca">
              </a>
            </div>
          </div>

          <div class="actions">
            <div class="agent">
              <div class="agent-avatar" aria-hidden="true" title="Agent or Team"></div>
              <div class="agent-info">
                <div class="agent-name">Agent or Team</div>
                <div class="agent-broker">Listing Brokerage: <strong>${it.brokerage}</strong></div>
              </div>
            </div>

            <div class="actions-cta">
              <a class="contact-btn" href="${mailto}" aria-label="Email about ${it.address}">Contact</a>
              <a class="details-link" href="${it.realtorca_url}" target="_blank" rel="noopener" aria-label="View details on REALTOR.ca">Details ‚Üí</a>
            </div>
          </div>`;
        grid.appendChild(el);
      });
    }

    function apply(){
      const sort=$('sort').value;
      try{
        VIEW = FILTERS.applyFilters(DATA, {
          q: $('q').value, city: $('city').value,
          beds: $('beds').value, baths: $('baths').value,
          minp: $('minp').value, maxp: $('maxp').value
        });
      }catch(e){ showErr('Filter error: ' + (e && e.message || e)); return; }
      switch(sort){
        case 'price-asc': VIEW.sort((a,b)=>a.price-b.price); break;
        case 'price-desc': VIEW.sort((a,b)=>b.price-a.price); break;
        case 'beds-desc': VIEW.sort((a,b)=>b.beds-a.beds); break;
        case 'baths-desc': VIEW.sort((a,b)=>b.baths-a.baths); break;
      }
      setParams(); renderCount(); renderChips(); renderGrid(); renderWhy();
    }

    function nearestOption(selectId, target){
      const sel=$(selectId), vals=[...sel.options].map(o=>+o.value||0).filter(Boolean);
      let best=''; let diff=1e15;
      vals.forEach(v=>{ const d=Math.abs(v-target); if(d<diff){ diff=d; best=String(v); } });
      sel.value=best;
    }
    function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); } }

    async function loadData(){
      const candidates = ['/data/listings.json','data/listings.json','/listings.json','listings.json'];
      for (const url of candidates){
        try{
          const res = await fetch(url,{cache:'no-store'});
          if(res.ok){
            console.log('[Findr] Loaded dataset from', url);
            return await res.json();
          }
        }catch(_e){}
      }
      throw new Error('Could not load listings.json from expected paths.');
    }

    function clearAll(){
      $('q').value=''; $('city').value=''; $('beds').value=''; $('baths').value='';
      $('minp').value=''; $('maxp').value=''; $('sort').value='relevance'; apply();
    }

    async function copyLink(btn){
      try{
        await navigator.clipboard.writeText(window.location.href);
        const old = btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=old,1200);
      }catch{ prompt('Copy this URL:', window.location.href); }
    }

    async function smartFromText(){
      const text = $('q').value || '';
      let spec = null;
      try {
        const res = await fetch('/.netlify/functions/intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (res.ok) spec = await res.json();
      } catch (_e) {}
      if (!spec) { spec = await FindrAI.withUserIntentGuard(text, AIDemo.parseUserIntentDemo); }
      try{
        if (spec.beds_min) $('beds').value = String(spec.beds_min);
        if (spec.baths_min) $('baths').value = String(spec.baths_min);
        if (spec.min_price) nearestOption('minp', spec.min_price);
        if (spec.max_price) nearestOption('maxp', spec.max_price);
        if (Array.isArray(spec.areas) && spec.areas.length) $('city').value = spec.areas[0];
        $('q').value = '';
        if (spec.sort) $('sort').value = spec.sort;
        apply(); $('why').open = true;
      }catch(err){ showErr('Smart parse apply failed: ' + (err && err.message || err)); }
    }

    async function boot(){
      try{
        DATA = await loadData(); VIEW = DATA.slice();
        const p = getParams();
        $('q').value=p.q; $('city').value=p.city; $('beds').value=p.beds; $('baths').value=p.baths;
        $('minp').value=p.minp; $('maxp').value=p.maxp; $('sort').value=p.sort;
        apply();
      }catch(e){
        showErr(e);
        $('grid').innerHTML = '<p class="muted">Could not load mock data. Ensure <code>web/data/listings.json</code> exists (preferred) or place <code>web/listings.json</code>.</p>';
      }
      $('q').addEventListener('input',debounce(apply,200));
      $('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); smartFromText(); }});
      ['city','beds','baths','minp','maxp','sort'].forEach(id=>document.getElementById(id).addEventListener('change',apply));
      $('smart-btn').addEventListener('click', smartFromText);
    }
    boot();
  </script>

  <script>
    // Open-this-search on Map
    (function(){
      try{
        var chips = document.getElementById('chips');
        if(!chips) return;
        var row = chips.parentElement;
        var link = document.createElement('a');
        link.id = 'open-map-link';
        link.href = 'map.html' + (location.search || '');
        link.textContent = 'Open this search on Map ‚Üí';
        link.className = 'muted';
        link.setAttribute('aria-label','Open this search on the map');
        link.style.marginLeft = 'auto';
        row.appendChild(link);

        function updateLink(){ try{ link.href = 'map.html' + (location.search || ''); }catch(_e){} }
        ['city','beds','baths','minp','maxp','sort','q'].forEach(function(id){
          var el = document.getElementById(id); if(!el) return;
          var ev = (id === 'q') ? 'input' : 'change';
          el.addEventListener(ev, function(){ setTimeout(updateLink, 0); });
        });
        var chipsEl = document.getElementById('chips');
        if (chipsEl) chipsEl.addEventListener('click', function(){ setTimeout(updateLink, 0); });
        window.addEventListener('popstate', updateLink);
      }catch(e){ /* noop */ }
    })();
  </script>

</body>
</html>
