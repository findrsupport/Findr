<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0f17">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Findr™ — Listings (Preview)</title>
  <meta name="description" content="Findr™ mock listings — compliant layout with filters and search." />
  <style>
    :root { --brand:#5ea1ff; --bg:#0b0f17; --fg:#e8eef7; --muted:#9fb0c9; --card:rgba(255,255,255,0.04); --stroke:#223148; --surface:#0f1624; --chip:#1a2335; --chip-border:#2a3c5a; }
    :root[data-theme="light"]{ --bg:#f7f9fc; --fg:#0e1420; --muted:#5a6c85; --card:#ffffff; --stroke:#e5ecf5; --surface:#ffffff; --chip:#f1f4f8; --chip-border:#e5ecf5; }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg)}
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 20px}

    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{font-weight:900}
    .navlinks{display:flex; align-items:center; gap:14px}
    .navlinks a{padding:8px 10px; border-radius:10px}
    .navlinks a.active{background:var(--card); border:1px solid var(--stroke)}
    .toggle{cursor:pointer; border:1px solid var(--stroke); background:var(--card); color:var(--fg); border-radius:10px; padding:8px 10px}

    .panel{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:14px}
    /* +1 column for City */
    .toolbar{display:grid; grid-template-columns:1.6fr repeat(5, minmax(120px, 0.5fr)) 1fr; gap:10px; align-items:center}
    @media (max-width: 900px){ .toolbar{grid-template-columns:1fr 1fr 1fr; grid-auto-rows:minmax(40px,auto)} }
    .searchbox{display:flex; gap:8px}
    input[type="search"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--surface); color:var(--fg)}
    .smart{border:1px solid var(--stroke); background:var(--card); color:var(--fg); border-radius:10px; padding:10px 12px; cursor:pointer}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .grid{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:14px; margin-top:14px}
    @media (max-width: 1024px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width: 700px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; overflow:hidden; display:flex; flex-direction:column}
    .img{width:100%; height:180px; object-fit:cover; background:#111}
    .content{padding:12px 14px}
    .row .addr{font-weight:800}
    .addr{font-weight:800; line-height:1.25}
    .price{font-weight:900}
    .meta{display:flex; gap:10px; font-size:12px; color:var(--muted); margin:6px 0 10px}
    .broker{font-size:12px; color:var(--muted)}
    .actions{display:flex; justify-content:space-between; align-items:center; gap:12px; background:var(--surface); margin-top:auto; padding:12px 14px; border-top:1px solid var(--stroke)}
    .pbr{display:flex; align-items:center; gap:8px}
    .pbr img{width:24px; height:24px; object-fit:contain}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:var(--chip); border:1px solid var(--chip-border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    .back{font-size:12px; margin-top:18px; color:var(--muted)}
    .muted{color:var(--muted)}
    details#why{margin-top:10px}
    details#why summary{cursor:pointer; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Nav -->
    <nav class="nav" role="navigation" aria-label="Primary">
      <div class="brand"><div class="logo" aria-label="Findr home">Findr™</div></div>
      <div class="navlinks">
        <a href="/">Home</a>
        <a href="listings.html" class="active" aria-current="page">Listings</a>
        <a href="map.html">Map</a>
        <button id="theme-toggle" class="toggle" type="button" aria-label="Toggle theme">🌙</button>
      </div>
    </nav>

    <!-- Controls -->
    <div class="panel">
      <div class="toolbar" role="region" aria-label="Search and filters">
        <div class="searchbox">
          <input id="q" type="search" placeholder='Describe your... or click “Smart”' aria-label="Search or describe your needs" />
          <button id="smart-btn" class="smart" type="button" aria-label="Convert description to filters">Smart</button>
        </div>

        <!-- City -->
        <select id="city" aria-label="City">
          <option value="">City (any)</option>
          <option>Vancouver</option><option>Burnaby</option><option>Richmond</option>
          <option>Surrey</option><option>Coquitlam</option><option>Port Moody</option>
          <option>Port Coquitlam</option><option>New Westminster</option>
          <option>Langley</option><option>Maple Ridge</option>
        </select>

        <!-- Beds (now up to 5+) -->
        <select id="beds" aria-label="Minimum bedrooms">
          <option value="">Beds (any)</option>
          <option value="1">1+ bed</option><option value="2">2+ bed</option>
          <option value="3">3+ bed</option><option value="4">4+ bed</option>
          <option value="5">5+ bed</option>
        </select>

        <!-- Baths (now up to 5+) -->
        <select id="baths" aria-label="Minimum bathrooms">
          <option value="">Baths (any)</option>
          <option value="1">1+ bath</option><option value="2">2+ bath</option>
          <option value="3">3+ bath</option><option value="4">4+ bath</option>
          <option value="5">5+ bath</option>
        </select>

        <!-- Better price ranges -->
        <select id="minp" aria-label="Min price">
          <option value="">Min price</option>
          <option value="250000">$250k</option><option value="400000">$400k</option>
          <option value="500000">$500k</option><option value="600000">$600k</option>
          <option value="750000">$750k</option><option value="1000000">$1.0M</option>
          <option value="1250000">$1.25M</option><option value="1500000">$1.5M</option>
          <option value="2000000">$2.0M</option>
        </select>
        <select id="maxp" aria-label="Max price">
          <option value="">Max price</option>
          <option value="400000">$400k</option><option value="500000">$500k</option>
          <option value="600000">$600k</option><option value="750000">$750k</option>
          <option value="1000000">$1.0M</option><option value="1250000">$1.25M</option>
          <option value="1500000">$1.5M</option><option value="2000000">$2.0M</option>
          <option value="3000000">$3.0M</option>
        </select>

        <!-- Sort -->
        <select id="sort" aria-label="Sort">
          <option value="relevance">Sort: Relevance</option>
          <option value="price-asc">Price ↑</option>
          <option value="price-desc">Price ↓</option>
          <option value="beds-desc">Beds ↓</option>
          <option value="baths-desc">Baths ↓</option>
        </select>
      </div>

      <div class="row" style="margin:12px 0 10px">
        <div class="muted" id="count" aria-live="polite">Loading…</div>
        <div class="chips" id="chips" aria-live="polite"></div>
        <div id="smart-status" class="muted" aria-live="polite" style="font-size:12px"></div>
      </div>
      <details id="why">
        <summary>Why these results?</summary>
        <div id="why-body" class="muted" style="margin-top:6px;"></div>
      </details>
    </div>

    <!-- Grid -->
    <div id="grid" class="grid" role="region" aria-label="Listings grid"></div>

    <div class="back">Tip: filter here, then open the <a href="map.html">map</a> to see the same set.</div>
  </div>

  <!-- Scripts -->
  <script src="config.js"></script>
  <script src="js/ai-guard.js"></script>
  <!-- Shared rules-based filters -->
  <script src="js/filters.js"></script>
  <!-- Demo-only NL→filters stub (intent only; never touches listing payloads) -->
  <script src="js/ai-demo.js"></script>

  <script>
    // Theme toggle
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('theme');
      if (saved) root.setAttribute('data-theme', saved);
      const btn = document.getElementById('theme-toggle');
      const isDark = () => root.getAttribute('data-theme') !== 'light';
      const render = () => { if(btn) btn.textContent = isDark() ? '🌙' : '☀️'; };
      if (btn) btn.addEventListener('click', () => {
        root.setAttribute('data-theme', isDark() ? 'light' : 'dark');
        localStorage.setItem('theme', root.getAttribute('data-theme'));
        render();
      });
      render();
    })();

    const $ = (id) => document.getElementById(id);
    const fmtPrice = (n) => new Intl.NumberFormat('en-CA', { style:'currency', currency:'CAD', maximumFractionDigits:0 }).format(n);
    let DATA=[], VIEW=[];

    // URL param sync
    function getParams(){
      const p = new URLSearchParams(location.search);
      return {
        q: p.get('q') || '',
        city: p.get('city') || '',
        beds: p.get('beds') || '',
        baths: p.get('baths') || '',
        minp: p.get('minp') || '',
        maxp: p.get('maxp') || '',
        sort: p.get('sort') || 'relevance'
      };
    }
    function setParams(){
      const p = new URLSearchParams();
      if($('q').value) p.set('q',$('q').value);
      if($('city').value) p.set('city',$('city').value);
      if($('beds').value) p.set('beds',$('beds').value);
      if($('baths').value) p.set('baths',$('baths').value);
      if($('minp').value) p.set('minp',$('minp').value);
      if($('maxp').value) p.set('maxp',$('maxp').value);
      if($('sort').value && $('sort').value!=='relevance') p.set('sort',$('sort').value);
      const newUrl = `${location.pathname}?${p.toString()}`;
      history.replaceState(null,'',newUrl);
    }

    function renderCount(){ $('count').textContent = `${VIEW.length} result${VIEW.length===1?'':'s'}`; }
    function renderWhy(){
      const parts=[];
      const q=$('q').value.trim(); if(q) parts.push(`Text: “${q}”`);
      if($('city').value) parts.push($('city').value);
      if($('beds').value) parts.push(`${$('beds').value}+ bed`);
      if($('baths').value) parts.push(`${$('baths').value}+ bath`);
      const minp=$('minp').value, maxp=$('maxp').value;
      if(minp||maxp){
        const left=minp?fmtPrice(+minp):'Any', right=maxp?fmtPrice(+maxp):'Any';
        parts.push(`Price: ${left}–${right}`);
      }
      const s = $('sort').selectedOptions[0].text;
      if($('sort').value!=='relevance') parts.push(`Sort: ${s}`);
      $('why-body').textContent = parts.length ? parts.join(' · ') : 'No active filters (all listings).';
    }

    function renderChips(){
      const chips = $('chips'); const active=[];
      const q=$('q').value.trim(); if(q) active.push({label:`Search: “${q}”`, id:'q'});
      const city=$('city').value; if(city) active.push({label:city, id:'city'});
      const beds=$('beds').value; if(beds) active.push({label:`${beds}+ bed`, id:'beds'});
      const baths=$('baths').value; if(baths) active.push({label:`${baths}+ bath`, id:'baths'});
      const minp=$('minp').value, maxp=$('maxp').value;
      if(minp||maxp){ active.push({label:`${minp?fmtPrice(+minp):'Any'}–${maxp?fmtPrice(+maxp):'Any'}`, id:'price'}); active.push({label:'Reset price', id:'price-reset'}); }
      const sort=$('sort').value; if(sort!=='relevance') active.push({label:`Sort: ${$('sort').selectedOptions[0].text}`, id:'sort'});
      active.push({label:'Copy link', id:'copy'}); active.push({label:'Clear all', id:'clear'});

      chips.innerHTML = active.map(c=>`<button class="chip" data-id="${c.id}" type="button" aria-label="${c.label}">${c.label}${c.id!=='copy'&&c.id!=='clear'?' ✕':''}</button>`).join('');
      chips.querySelectorAll('.chip').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id');
        if(id==='copy'){ copyLink(b); return; }
        if(id==='clear'){ clearAll(); return; }
        if(id==='price-reset'){ $('minp').value=''; $('maxp').value=''; apply(); return; }
        if(id==='q') $('q').value='';
        if(id==='city') $('city').value='';
        if(id==='beds') $('beds').value='';
        if(id==='baths') $('baths').value='';
        if(id==='price'){ $('minp').value=''; $('maxp').value=''; }
        if(id==='sort') $('sort').value='relevance';
        apply();
      }));
    }

    function renderGrid(){
      const grid=$('grid'); grid.innerHTML='';
      VIEW.forEach(it=>{
        const el=document.createElement('article'); el.className='card';
        el.innerHTML=`
          <img class="img" src="${it.photo}" alt="Photo of ${it.address}, ${it.city}">
          <div class="content">
            <div class="row"><div class="addr">${it.address}</div><div class="price">${fmtPrice(it.price)}</div></div>
            <div class="meta"><span>${it.city}</span><span>•</span><span>${it.beds} bd</span><span>•</span><span>${it.baths} ba</span></div>
            <div class="broker">Listing Brokerage: <strong>${it.brokerage}</strong></div>
          </div>
          <div class="actions">
            <a class="pbr" href="${it.realtorca_url}" target="_blank" rel="noopener" aria-label="View on REALTOR.ca">
              <img src="https://static.realtor.ca/branding/powered-by-realtor.png" alt="Powered by REALTOR.ca" width="24" height="24"> REALTOR.ca
            </a>
            <a href="${it.realtorca_url}" target="_blank" rel="noopener">Details →</a>
          </div>`;
        grid.appendChild(el);
      });
    }

    function apply(){
      const sort=$('sort').value;
      VIEW = FILTERS.applyFilters(DATA, {
        q: $('q').value, city: $('city').value,
        beds: $('beds').value, baths: $('baths').value,
        minp: $('minp').value, maxp: $('maxp').value
      });
      switch(sort){
        case 'price-asc': VIEW.sort((a,b)=>a.price-b.price); break;
        case 'price-desc': VIEW.sort((a,b)=>b.price-a.price); break;
        case 'beds-desc': VIEW.sort((a,b)=>b.beds-a.beds); break;
        case 'baths-desc': VIEW.sort((a,b)=>b.baths-a.baths); break;
      }
      setParams(); renderCount(); renderChips(); renderGrid(); renderWhy();
    }

    function nearestOption(selectId, target){
      const sel=$(selectId), vals=[...sel.options].map(o=>+o.value||0).filter(Boolean);
      let best=''; let diff=1e15;
      vals.forEach(v=>{ const d=Math.abs(v-target); if(d<diff){ diff=d; best=String(v); } });
      sel.value=best;
    }

    function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); } }

    async function loadData(){
      const candidates = ['/data/listings.json','data/listings.json','/listings.json','listings.json'];
      for (const url of candidates){
        try{ const res = await fetch(url,{cache:'no-store'}); if(res.ok) return await res.json(); }catch(_e){}
      }
      throw new Error('Could not load listings.json from expected paths.');
    }

    function clearAll(){
      $('q').value=''; $('city').value=''; $('beds').value=''; $('baths').value='';
      $('minp').value=''; $('maxp').value=''; $('sort').value='relevance'; apply();
    }

    async function copyLink(btn){
      try{
        await navigator.clipboard.writeText(window.location.href);
        const old = btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=old,1200);
      }catch{ prompt('Copy this URL:', window.location.href); }
    }

    let SMART_STATUS='';
    function updateSmartStatus(){ const el=$('smart-status'); if(!el) return; el.textContent = SMART_STATUS ? `Smart: ${SMART_STATUS}` : ''; }
    async function smartFromText(){
      const text = $('q').value || '';
      let spec = null;
      let usedFallback = false;

      try {
        const res = await fetch('/.netlify/functions/intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (res.ok) spec = await res.json();
      } catch (e) {
        console.debug('Intent API not available, falling back to demo:', e);
      }

      if (!spec) { usedFallback = true; spec = await FindrAI.withUserIntentGuard(text, AIDemo.parseUserIntentDemo); }

      try{
        if (spec.beds_min) $('beds').value = String(spec.beds_min);
        if (spec.baths_min) $('baths').value = String(spec.baths_min);
        if (spec.min_price) nearestOption('minp', spec.min_price);
        if (spec.max_price) nearestOption('maxp', spec.max_price);
        if (Array.isArray(spec.areas) && spec.areas.length) $('city').value = spec.areas[0];
        $('q').value = '';
        if (spec.sort) $('sort').value = spec.sort;
        apply(); SMART_STATUS = usedFallback ? 'fallback' : 'server parser'; updateSmartStatus(); $('why').open = true;
      }catch(err){ console.debug('Smart parse apply failed:', err); }
    }

    async function boot(){
      try{
        DATA = await loadData(); VIEW = DATA.slice();
        const p = getParams();
        $('q').value=p.q; $('city').value=p.city; $('beds').value=p.beds; $('baths').value=p.baths;
        $('minp').value=p.minp; $('maxp').value=p.maxp; $('sort').value=p.sort;
        apply();
      }catch(e){
        console.error(e);
        $('grid').innerHTML = '<p class="muted">Could not load mock data. Ensure <code>web/data/listings.json</code> exists (preferred) or place <code>web/listings.json</code>.</p>';
      }
      $('q').addEventListener('input',debounce(apply,200));
      $('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); smartFromText(); }});
      ['city','beds','baths','minp','maxp','sort'].forEach(id=>document.getElementById(id).addEventListener('change',apply));
      $('smart-btn').addEventListener('click', smartFromText);
    }
    boot();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function(){
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      });
    }
  </script>
</body>
</html>
