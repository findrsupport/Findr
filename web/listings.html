<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Findr‚Ñ¢ ‚Äî Listings (Preview)</title>
  <meta name="description" content="Findr‚Ñ¢ mock listings ‚Äî compliant layout with filters and search." />
  <style>
    :root {
      --brand:#5ea1ff; --bg:#0b0f17; --fg:#e8eef7; --muted:#9fb0c9; --card:rgba(255,255,255,0.04); --stroke:#223148; --surface:#0f1624;
      --chip:#1a2335; --chip-border:#2a3c5a;
    }
    :root[data-theme="light"]{
      --bg:#f7f9fc; --fg:#0e1420; --muted:#5a6c85; --card:#ffffff; --stroke:#e5ecf5; --surface:#ffffff;
      --chip:#f1f4f8; --chip-border:#e5ecf5;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg)}
    a{color:var(--brand); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:28px 20px}

    /* Nav */
    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 0}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{font-weight:900}
    .navlinks{display:flex; align-items:center; gap:14px}
    .navlinks a{padding:8px 10px; border-radius:10px}
    .navlinks a.active{background:var(--card); border:1px solid var(--stroke)}
    .toggle{cursor:pointer; border:1px solid var(--stroke); background:var(--card); color:var(--fg); border-radius:10px; padding:8px 10px}

    .panel{background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:14px}
    .toolbar{display:grid; grid-template-columns:1.6fr repeat(4, minmax(120px, 0.5fr)) 1fr; gap:10px; align-items:center}
    @media (max-width: 900px){ .toolbar{grid-template-columns:1fr 1fr 1fr; grid-auto-rows:minmax(40px,auto)} }
    .searchbox{display:flex; gap:8px}
    input[type="search"], select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--surface); color:var(--fg); font:inherit}
    .smart{white-space:nowrap; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--card); color:var(--fg); cursor:pointer}
    .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); margin-top:14px}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; transition:transform .15s ease, box-shadow .2s ease}
    .card:hover{ transform:translateY(-2px); box-shadow:0 6px 28px rgba(0,0,0,.25) }
    .img{aspect-ratio:4/3; width:100%; object-fit:cover; background:#0a0f18}
    .content{padding:14px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .addr{font-weight:800; line-height:1.25}
    .price{font-weight:900}
    .meta{display:flex; gap:10px; font-size:12px; color:var(--muted); margin:6px 0 10px}
    .broker{font-size:12px; color:var(--muted)}
    .actions{display:flex; justify-content:space-between; align-items:center; margin-top:auto; padding:12px 14px; border-top:1px solid var(--stroke)}
    .pbr{display:flex; align-items:center; gap:8px}
    .pbr img{width:24px; height:24px; object-fit:contain}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{background:var(--chip); border:1px solid var(--chip-border); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    .back{font-size:12px; margin-top:18px; color:var(--muted)}
    .muted{color:var(--muted)}
    details#why{margin-top:10px}
    details#why summary{cursor:pointer; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Nav -->
    <nav class="nav" role="navigation" aria-label="Primary">
      <div class="brand">
        <div class="logo" aria-label="Findr home">Findr‚Ñ¢</div>
      </div>
      <div class="navlinks">
        <a href="/">Home</a>
        <a href="listings.html" class="active" aria-current="page">Listings</a>
        <a href="map.html">Map</a>
        <button id="theme-toggle" class="toggle" type="button" aria-label="Toggle theme">üåô</button>
      </div>
    </nav>

    <!-- Controls -->
    <div class="panel">
      <div class="toolbar" role="region" aria-label="Search and filters">
        <div class="searchbox">
          <input id="q" type="search" placeholder='Describe your needs, then press Enter or click ‚ÄúSmart‚Äù (e.g., "2 bed condo near SkyTrain under 900k")' aria-label="Search or describe your needs" />
          <button id="smart-btn" class="smart" type="button" aria-label="Convert description to filters">Smart</button>
        </div>
        <select id="beds" aria-label="Minimum bedrooms">
          <option value="">Beds (any)</option><option value="1">1+ bed</option><option value="2">2+ bed</option><option value="3">3+ bed</option><option value="4">4+ bed</option>
        </select>
        <select id="baths" aria-label="Minimum bathrooms">
          <option value="">Baths (any)</option><option value="1">1+ bath</option><option value="2">2+ bath</option><option value="3">3+ bath</option>
        </select>
        <select id="minp" aria-label="Min price">
          <option value="">Min price</option><option value="400000">$400k</option><option value="600000">$600k</option><option value="800000">$800k</option><option value="1000000">$1M</option>
        </select>
        <select id="maxp" aria-label="Max price">
          <option value="">Max price</option><option value="700000">$700k</option><option value="900000">$900k</option><option value="1200000">$1.2M</option><option value="1500000">$1.5M</option>
        </select>
        <select id="sort" aria-label="Sort">
          <option value="relevance">Sort: Relevance</option><option value="price-asc">Price ‚Üë</option><option value="price-desc">Price ‚Üì</option><option value="beds-desc">Beds ‚Üì</option><option value="baths-desc">Baths ‚Üì</option>
        </select>
      </div>
      <div class="row" style="margin:12px 0 10px">
        <div class="muted" id="count" aria-live="polite">Loading‚Ä¶</div>
        <div class="chips" id="chips" aria-live="polite"></div>
      </div>
      <details id="why">
        <summary>Why these results?</summary>
        <div id="why-body" class="muted" style="margin-top:6px;"></div>
      </details>
    </div>

    <section id="grid" class="grid" aria-live="polite"></section>
    <p class="back"><a href="/">‚Üê Back to Home</a></p>
  </div>

  <!-- Compliance scaffolding -->
  <script src="config.js"></script>
  <script src="js/ai-guard.js"></script>
  <!-- Shared rules-based filters -->
  <script src="js/filters.js"></script>
  <!-- Demo-only NL‚Üífilters stub (intent only; never touches listing payloads) -->
  <script src="js/ai-demo.js"></script>

  <script>
    // Theme toggle
    (function(){
      const root = document.documentElement;
      const saved = localStorage.getItem('theme');
      if (saved) root.setAttribute('data-theme', saved);
      const btn = document.getElementById('theme-toggle');
      const isDark = () => root.getAttribute('data-theme') !== 'light';
      const render = () => { if(btn) btn.textContent = isDark() ? 'üåô' : '‚òÄÔ∏è'; };
      if (btn) {
        btn.addEventListener('click', () => {
          root.setAttribute('data-theme', isDark() ? 'light' : 'dark');
          localStorage.setItem('theme', root.getAttribute('data-theme'));
          render();
        });
      }
      render();
    })();

    // Helpers
    const $ = (id) => document.getElementById(id);
    const fmtPrice = (n) => new Intl.NumberFormat('en-CA', { style:'currency', currency:'CAD', maximumFractionDigits:0 }).format(n);
    let DATA=[], VIEW=[];

    // URL param sync
    function getParams(){
      const p = new URLSearchParams(location.search);
      return {
        q: p.get('q') || '',
        beds: p.get('beds') || '',
        baths: p.get('baths') || '',
        minp: p.get('minp') || '',
        maxp: p.get('maxp') || '',
        sort: p.get('sort') || 'relevance'
      };
    }
    function setParams(){
      const p = new URLSearchParams();
      if($('q').value) p.set('q',$('q').value);
      if($('beds').value) p.set('beds',$('beds').value);
      if($('baths').value) p.set('baths',$('baths').value);
      if($('minp').value) p.set('minp',$('minp').value);
      if($('maxp').value) p.set('maxp',$('maxp').value);
      if($('sort').value && $('sort').value!=='relevance') p.set('sort',$('sort').value);
      const newUrl = `${location.pathname}?${p.toString()}`;
      history.replaceState(null,'',newUrl);
    }

    function renderCount(){ $('count').textContent = `${VIEW.length} result${VIEW.length===1?'':'s'}`; }

    function renderWhy(){
      const parts=[];
      const q=$('q').value.trim(); if(q) parts.push(`Text: ‚Äú${q}‚Äù`);
      if($('beds').value) parts.push(`${$('beds').value}+ bed`);
      if($('baths').value) parts.push(`${$('baths').value}+ bath`);
      const minp=$('minp').value, maxp=$('maxp').value;
      if(minp||maxp){
        const left=minp?fmtPrice(+minp):'Any', right=maxp?fmtPrice(+maxp):'Any';
        parts.push(`Price: ${left}‚Äì${right}`);
      }
      const s = $('sort').selectedOptions[0].text;
      if($('sort').value!=='relevance') parts.push(`Sort: ${s}`);
      $('why-body').textContent = parts.length ? parts.join(' ¬∑ ') : 'No active filters (all listings).';
    }

    function renderChips(){
      const chips = $('chips'); const active=[];
      const q=$('q').value.trim(); if(q) active.push({label:`Search: ‚Äú${q}‚Äù`, id:'q'});
      const beds=$('beds').value; if(beds) active.push({label:`${beds}+ bed`, id:'beds'});
      const baths=$('baths').value; if(baths) active.push({label:`${baths}+ bath`, id:'baths'});
      const minp=$('minp').value, maxp=$('maxp').value;
      if(minp||maxp) active.push({label:`${minp?fmtPrice(+minp):'Any'}‚Äì${maxp?fmtPrice(+maxp):'Any'}`, id:'price'});
      const sort=$('sort').value; if(sort!=='relevance') active.push({label:`Sort: ${$('sort').selectedOptions[0].text}`, id:'sort'});
      // utility chips
      active.push({label:'Copy link', id:'copy'});
      active.push({label:'Clear all', id:'clear'});

      chips.innerHTML = active.map(c=>`<button class="chip" data-id="${c.id}" title="${c.id==='copy'?'Copy current URL to clipboard':'Clear filters'}">${c.label}${c.id!=='copy'&&c.id!=='clear'?' ‚úï':''}</button>`).join('');
      chips.querySelectorAll('.chip').forEach(b=>b.addEventListener('click',()=>{
        const id=b.getAttribute('data-id');
        if(id==='copy'){ copyLink(b); return; }
        if(id==='clear'){ clearAll(); return; }
        if(id==='q') $('q').value=''; if(id==='beds') $('beds').value=''; if(id==='baths') $('baths').value='';
        if(id==='price'){ $('minp').value=''; $('maxp').value=''; } if(id==='sort') $('sort').value='relevance'; apply();
      }));
    }

    function renderGrid(){
      const grid=$('grid'); grid.innerHTML='';
      VIEW.forEach(it=>{
        const el=document.createElement('article'); el.className='card';
        el.innerHTML=`
          <img class="img" src="${it.photo}" alt="Photo of ${it.address}, ${it.city}">
          <div class="content">
            <div class="row"><div class="addr">${it.address}</div><div class="price">${fmtPrice(it.price)}</div></div>
            <div class="meta"><span>${it.city}</span><span>‚Ä¢</span><span>${it.beds} bd</span><span>‚Ä¢</span><span>${it.baths} ba</span></div>
            <div class="broker">Listing Brokerage: <strong>${it.brokerage}</strong></div>
          </div>
          <div class="actions">
            <a class="pbr" href="${it.realtorca_url}" target="_blank" rel="noopener" aria-label="View on REALTOR.ca">
              <img src="assets/powered-by-realtor.svg" alt="Powered by REALTOR.ca" /><span style="color:var(--muted)">View on REALTOR.ca</span>
            </a>
            <a href="${it.realtorca_url}" target="_blank" rel="noopener">Details ‚Üí</a>
          </div>`;
        grid.appendChild(el);
      });
    }

    function apply(){
      const sort=$('sort').value;
      // deterministic, shared filters
      VIEW = FILTERS.applyFilters(DATA, {
        q: $('q').value, beds: $('beds').value, baths: $('baths').value,
        minp: $('minp').value, maxp: $('maxp').value
      });
      switch(sort){
        case 'price-asc': VIEW.sort((a,b)=>a.price-b.price); break;
        case 'price-desc': VIEW.sort((a,b)=>b.price-a.price); break;
        case 'beds-desc': VIEW.sort((a,b)=>b.beds-a.beds); break;
        case 'baths-desc': VIEW.sort((a,b)=>b.baths-a.baths); break;
      }
      setParams();
      renderCount(); renderChips(); renderGrid(); renderWhy();
    }

    function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); } }

    // Resilient loader
    async function loadData(){
      const candidates = ['/data/listings.json','data/listings.json','/listings.json','listings.json'];
      for (const url of candidates){
        try{ const res = await fetch(url,{cache:'no-store'}); if(res.ok) return await res.json(); }catch(_e){}
      }
      throw new Error('Could not load listings.json from expected paths.');
    }

    // Server-first Smart ‚Üí filters; fallback to demo parser
    function nearestOption(selectId, value){
      if (!value) return;
      const sel = $(selectId); const opts=[...sel.options].map(o=>o.value).filter(Boolean).map(Number).sort((a,b)=>a-b);
      if (!opts.length) return;
      let chosen = opts.find(v=>v>=value) ?? opts[opts.length-1];
      sel.value = String(chosen);
    }

    async function smartFromText(){
      const text = $('q').value || '';
      let spec = null;

      try {
        const res = await fetch('/.netlify/functions/intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        if (res.ok) spec = await res.json();
      } catch (e) {
        console.debug('Intent API not available, falling back to demo:', e);
      }

      if (!spec) {
        spec = await FindrAI.withUserIntentGuard(text, AIDemo.parseUserIntentDemo);
      }

      try{
        if (spec.beds_min) $('beds').value = String(spec.beds_min);
        if (spec.baths_min) $('baths').value = String(spec.baths_min);
        if (spec.min_price) nearestOption('minp', spec.min_price);
        if (spec.max_price) nearestOption('maxp', spec.max_price);
        if (Array.isArray(spec.areas) && spec.areas.length){
          const t = $('q').value.trim();
          if (!t.toLowerCase().includes(spec.areas[0].toLowerCase())) {
            $('q').value = `${t ? t+' ' : ''}${spec.areas[0]}`.trim();
          }
        }
        if (spec.sort) $('sort').value = spec.sort;
        apply();
        $('why').open = true;
      }catch(err){
        console.debug('Smart parse apply failed:', err);
      }
    }

    function clearAll(){
      $('q').value=''; $('beds').value=''; $('baths').value=''; $('minp').value=''; $('maxp').value=''; $('sort').value='relevance';
      apply();
    }

    async function copyLink(btn){
      try{
        await navigator.clipboard.writeText(window.location.href);
        const old = btn.textContent; btn.textContent = 'Copied!';
        setTimeout(()=>btn.textContent=old, 1200);
      }catch{
        prompt('Copy this URL:', window.location.href);
      }
    }

    async function boot(){
      try{
        DATA = await loadData(); VIEW = DATA.slice();
        const p = getParams();
        $('q').value=p.q; $('beds').value=p.beds; $('baths').value=p.baths; $('minp').value=p.minp; $('maxp').value=p.maxp; $('sort').value=p.sort;
        apply();
      }catch(e){
        console.error(e);
        $('grid').innerHTML = '<p class="muted">Could not load mock data. Ensure <code>web/data/listings.json</code> exists (preferred) or place <code>web/listings.json</code>.</p>';
      }
      $('q').addEventListener('input',debounce(apply,200));
      $('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); smartFromText(); }});
      ['beds','baths','minp','maxp','sort'].forEach(id=>document.getElementById(id).addEventListener('change',apply));
      $('smart-btn').addEventListener('click', smartFromText);
    }
    boot();
  </script>
</body>
</html>
